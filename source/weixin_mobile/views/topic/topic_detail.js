'use strict';angular.module('zenmezApp')  .controller('TopicDetailCtrl', function ($scope, $state, $http, $stateParams , $location) {  	$scope.model = {};  	$scope.isLoading = true;    $scope.noMoreItemsAvailable = false;    $scope.topic_id = $stateParams.id;    $scope.user_id = $stateParams.user_id;    $scope.position = 'br';    $scope.effect = 'zoomin';    $scope.method = 'click';    var is_page = 1 ,      topic_id = $scope.topic_id,      pindex = 1;    function fetchData(){      var path = "/mobile/topic/detail/"+ topic_id +"/" + pindex;      var promise = $http.get(path);      promise.success(function(rs ,state ){        $scope.isLoading = false;        pindex +=1;        is_page = rs.data.is_page;        $scope.model.detail = rs.data;        $scope.noMoreItemsAvailable = true;      });      promise.error(function(data ,state ){        console.log("服务器请求数据出错！");      });    };    $scope.onTapSNS = function(){      var flag = -1;      $scope.model.detail.sns = !$scope.model.detail.sns;      if($scope.model.detail.sns){        flag = 1;      }else{        flag = 0 ;      }      $http.get("/mobile/topic/sns/"+  $scope.topic_id +"/2/1/"+flag);    };    $scope.onChangeSNS = function(id){      angular.forEach($scope.model.detail.list , function(item){        if(item.reply_id == id){          var flag = -1;          if(item.sns == 1){            item.sns_count -= 1;            item.sns = 0;            flag = 0;          }else{            item.sns_count += 1;            item.sns = 1;            flag = 1;          }          $http.get("/mobile/topic/sns/"+ id +"/1/2/"+flag);        }      });    };    $scope.toggle = function(state){      $location.path('/reply/'+ $scope.topic_id +'/' + $scope.user_id + '/');    }    $scope.$on('$ionicView.beforeEnter' , function(e){      pindex = 1;      fetchData();    });    $scope.loadMore = function() {      if(is_page == 0){        $scope.noMoreItemsAvailable = false;        $scope.$broadcast('scroll.infiniteScrollComplete');      }      if(is_page){        loadMore();      }    };    function loadMore(){      var path = "/mobile/topic/detail/"+ topic_id +"/" + (pindex);      var promise = $http.get(path);      promise.success(function(rs){        is_page = rs.data.is_page;        pindex +=1;        $scope.model.detail.replies= $scope.model.detail.replies.concat(rs.data.replies);        $scope.$broadcast('scroll.infiniteScrollComplete');      });      promise.error(function(data){        console.log("服务器请求数据出错！");        $scope.$broadcast('scroll.infiniteScrollComplete');      });    }  })  .config(function($stateProvider) {    $stateProvider	  .state('topic_detail', {	    url: "/topic_detail/:id/:user_id",      templateUrl: "views/topic/topic_detail.tpl.html",      controller : 'TopicDetailCtrl'	  });});